<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  
  
  
  <meta name="description" content="穷则独善其身">
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>
    WEB：Audio 音频基础 |
    
    zeus の blog</title>
  
  <link rel="shortcut icon" href="/zeus.ico">
  
  
<link rel="stylesheet" href="/css/style.css">

  
  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<script src="/js/pace.min.js"></script>

<meta name="generator" content="Hexo 7.2.0"></head>

<body>
  <main class="content">
    <section class="outer">
  <article id="post-web-audio" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
      

<h1 class="article-title" itemprop="name">
  WEB：Audio 音频基础
</h1>



    </header>
    

    
    <div class="article-meta">
      <a href="/2021/06/27/web-audio/" class="article-date">
  <time datetime="2021-06-27T03:01:01.000Z" itemprop="datePublished">2021-06-27</time>
</a>
      
    </div>
    

    
    
<div class="tocbot"></div>

    

    <div class="article-entry" itemprop="articleBody">
      
      
      
      <p>Web Audio API (AduioContext) 实在太多了，当然玩起来也会很有趣。</p>
<span id="more"></span>

<p><img src="/images/web-audio/audio.jpeg" alt="PCM"></p>
<h2 id="基础概念"><a href="#基础概念" class="headerlink" title="基础概念"></a>基础概念</h2><p>声音：根据初中物理知识，声音是由物体振动产生的__声波__，通过介质（空气或固体、液体）传播，被人或动物听觉器官所感知的波动现象。气压的变化会产生声音信号，声音是一种波。人的耳朵可以听到20<del>20000Hz的声音，最敏感是200</del>800Hz之间的声音，蚊子挥动翅膀的频率刚好就在 600Hz 左右（频率越高音调 pitch 或 key 越高）。</p>
<p>我们可以测量压力变化的强度，并绘制随时间变化的测量值。其中音频采样，是把声音从模拟信号转换为数字信号，所得的被称为 <code>PCM</code> 。</p>
<p><img src="/images/web-audio/audio-steps.png" alt="PCM"></p>
<ul>
<li>模拟信号：通常指连续的物理量，例如温度、湿度、速度、光照、声响等</li>
<li>数字信号：通常是模拟信号经过采样、量化和编码等几个步骤后得到的</li>
</ul>
<h2 id="PCM"><a href="#PCM" class="headerlink" title="PCM"></a>PCM</h2><p> <code>PCM</code> (脉冲编码调制）有<a href="https://www.cnblogs.com/yongdaimi/p/10722355.html">三要素</a>：声道数（channel number）、采样率（sample rate）、采样位数或位深（bit depth）。</p>
<p><img src="/images/web-audio/pcm.png" alt="PCM"></p>
<blockquote>
<p>PCM 是一种编码格式，WAV 是一种文件格式。</p>
</blockquote>
<h3 id="声道数"><a href="#声道数" class="headerlink" title="声道数"></a>声道数</h3><p>声道数，常见的声道（喇叭数量）类型：</p>
<ul>
<li>单声道：Mono，单喇叭或者两个喇叭输出同一个声道的声音（<strong>在线 ASR 录音用的是单声道</strong>）</li>
<li>双声道：Stereo，分左声道和右声道，更加有空间效果</li>
</ul>
<p><img src="/images/web-audio/channel.png" alt="双声道"></p>
<h3 id="采样率"><a href="#采样率" class="headerlink" title="采样率"></a>采样率</h3><p>采样率：每秒对声音进行采集的次数，同样也是所得的数字信号的每秒样本数，单位为 Hz。<strong>采样率越高，声音的质量就越好，声音的还原就越真实越自然。</strong></p>
<p>当然人耳对频率识别范围有限，超过 48k 的采样率意义不大，一般 20k 可以满足， <strong>22050 Hz</strong> 为常用的采样频率。</p>
<ul>
<li>采样率：数字音频系统记录声音信号时每秒采集的数据个数</li>
<li>声音频率：物体每秒的震动频率</li>
</ul>
<blockquote>
<p><a href="https://www.zhihu.com/question/27644914">声音频率和采样率的区别</a>：其实它们之间没有直接关系，不是同一回事。</p>
</blockquote>
<p><img src="/images/web-audio/sample-rate.png" alt="采样率"></p>
<h3 id="采样位数"><a href="#采样位数" class="headerlink" title="采样位数"></a>采样位数</h3><p>采样位数：采样后，将采样的单个样本进行量化，用来衡量声音波动变化的一个参数，也可以说是声卡的分辨率。<strong>它的数值越大，分辨率也就越高，所发出声音的能力就越强，声音越好。</strong></p>
<p>n-bit 指的是声音的强度（振幅）被均分为 2^n 级，常用的有 8bit（1字节）、<code>16bit（2字节）</code>、32bit（4字节）。振幅越大，音量越大。</p>
<p>在把量化所得的结果，即单个声道的样本，以<code>二进制</code>的码字进行存放。</p>
<blockquote>
<p>B for Byte (字节)， b for bit（位）。1 Byte &#x3D; 8 bit</p>
</blockquote>
<p><img src="/images/web-audio/bit-depth.png" alt="采样位数"></p>
<h3 id="比特率"><a href="#比特率" class="headerlink" title="比特率"></a>比特率</h3><p>比特率：每秒的传输速率，单位为 bps。</p>
<p>采样率为 16khz，位深为 16 bit，单声道的比特率为 <code>16000 * 16 * 1 = 256000 b/s（比特/秒）</code>，转化为字节 <code>256000 / 8 = 32000 B/s（字节/秒）</code>。</p>
<blockquote>
<p>通常说的 10M 带宽为 10Mbps（这里是比特），下载速率为 10M &#x2F; 8 &#x3D; 1.25 MB&#x2F;s（这里是字节）</p>
</blockquote>
<h2 id="音频采集"><a href="#音频采集" class="headerlink" title="音频采集"></a>音频采集</h2><p>讲述完 PCM 的基础概念后，开始谈谈如何通过浏览器实现音频采集。</p>
<h3 id="getUserMedia"><a href="#getUserMedia" class="headerlink" title="getUserMedia"></a>getUserMedia</h3><p>实现媒体音频采集的是 <code>WebRTC</code> 技术，使用的方法是 <code>navigator.mediaDevices.getUserMedia()</code>，需要做低版本兼容。麦克风或摄像头的启用涉及到安全隐私，通常网页中会有弹框提示，用户确认后才可启用相关功能，调用成功后，回调函数中就可以得到<strong>多媒体流对象</strong>，后续的工作就是围绕这个<code>媒体流(MediaStream)</code>展开的。</p>
<p><img src="/images/web-audio/web-audio-api.png" alt="wav-audio-api"></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">navigator.<span class="property">mediaDevices</span>.<span class="title function_">getUserMedia</span>(&#123;<span class="attr">audio</span>:<span class="literal">true</span>&#125;)</span><br><span class="line">  .<span class="title function_">then</span>(<span class="function"><span class="params">mediaStream</span>=&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// audioInput 表示音频源节点</span></span><br><span class="line">    <span class="keyword">const</span> audioInput = audioContext.<span class="title function_">createMediaStreamSource</span>(stream);</span><br><span class="line">    <span class="comment">// scriptProcessorNode 为关键节点</span></span><br><span class="line">    <span class="keyword">const</span> recorder = audioContext.<span class="title function_">createScriptProcessor</span>(<span class="number">4096</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">    <span class="comment">// 音频采集，每采集完样本帧预设数值（4096）后会触发 onaudioprocess 接口一次</span></span><br><span class="line">    recorder.<span class="property">onaudioprocess</span> = <span class="function">(<span class="params">e: &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">      inputBuffer: AudioBuffer;</span></span></span><br><span class="line"><span class="params"><span class="function">      outputBuffer: AudioBuffer;</span></span></span><br><span class="line"><span class="params"><span class="function">    &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 核心：处理 AudioBuffer 逻辑，假设是单声道</span></span><br><span class="line">      <span class="title function_">encodePCM</span>(<span class="title function_">compress</span>(e.<span class="property">inputBuffer</span>.<span class="title function_">getChannelData</span>(<span class="number">0</span>)))</span><br><span class="line">    &#125;</span><br><span class="line">    audioInput.<span class="title function_">connect</span>(recorder);</span><br><span class="line">    recorder.<span class="title function_">connect</span>(audioContext.<span class="property">destination</span>);</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure>

<p>核心过程：</p>
<ol>
<li><p>通过 createMediaStreamSource 方法创建 MediaStreamAudioSourceNode 音频源节点</p>
</li>
<li><p>通过 createScriptProcessor 方法创建 scriptProcessorNode 脚本处理节点</p>
</li>
<li><p>通过 scriptProcessorNode 节点的 onaudioprocess 回调函数<strong>处理音频逻辑</strong></p>
</li>
</ol>
<h4 id="AudioBuffer"><a href="#AudioBuffer" class="headerlink" title="AudioBuffer"></a><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/AudioBuffer">AudioBuffer</a></h4><p>AudioBuffer接口表示存在内存里的一段短小的音频资源。缓存区（buffer）包含以下数据：不间断的 IEEE754 32 位线性PCM，从-1到1的范围额定，就是说，32位的浮点缓存区的每个样本在-1.0到1.0之间。</p>
<h4 id="采样率的转写"><a href="#采样率的转写" class="headerlink" title="采样率的转写"></a>采样率的转写</h4><p>音频是由浏览器采样率（一般为 48k）采集的，需要进行转写为我们真正需要的采样率（假设 16k），只支持由高转低，<strong>具体为按照输入采样率和输出采样率的比例，每隔比例位数取1位</strong>。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据输入和输出的采样率压缩数据，</span></span><br><span class="line"><span class="comment"> * 比如输入的采样率是48k的，我们需要的是（输出）的是16k的，由于48k与16k是3倍关系，</span></span><br><span class="line"><span class="comment"> * 所以输入数据中每隔3取1位</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">float32array</span>&#125; data       [-1, 1]的pcm数据</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">number</span>&#125; inputSampleRate  输入采样率</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">number</span>&#125; outputSampleRate 输出采样率</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span>  &#123;<span class="type">float32array</span>&#125;         压缩处理后的二进制数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">interleave</span>(<span class="params">data: <span class="built_in">Float32Array</span>, inputSampleRate: number, outputSampleRate: number</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> t = data.<span class="property">length</span>;</span><br><span class="line">    <span class="keyword">let</span> s = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">const</span> o = inputSampleRate / outputSampleRate;</span><br><span class="line">    <span class="keyword">const</span> u = <span class="title class_">Math</span>.<span class="title function_">ceil</span>((t * outputSampleRate) / inputSampleRate);</span><br><span class="line">    <span class="keyword">const</span> a = <span class="keyword">new</span> <span class="title class_">Float32Array</span>(u);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; u; i++) &#123;</span><br><span class="line">      a[i] = data[<span class="title class_">Math</span>.<span class="title function_">floor</span>(s)];</span><br><span class="line">      s += o;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> a;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h4 id="位深的转写"><a href="#位深的转写" class="headerlink" title="位深的转写"></a>位深的转写</h4><p>采样率的问题解决完，还需要将音频流转为对应位深，生成长度为（位深&#x2F;8 * 音频原长度）的 Uint8Array。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// bit reduce and convert to integer</span></span><br><span class="line"><span class="keyword">switch</span> (<span class="variable language_">this</span>.<span class="property">bytesPerSample</span>) &#123;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">4</span>: <span class="comment">// 32 bits signed</span></span><br><span class="line">    sample = sample * <span class="number">2147483647.5</span> - <span class="number">0.5</span>;</span><br><span class="line">    reducedData[outputIndex] = sample;</span><br><span class="line">    <span class="comment">// tslint:disable-next-line:no-bitwise</span></span><br><span class="line">    reducedData[outputIndex + <span class="number">1</span>] = sample &gt;&gt; <span class="number">8</span>;</span><br><span class="line">    <span class="comment">// tslint:disable-next-line:no-bitwise</span></span><br><span class="line">    reducedData[outputIndex + <span class="number">2</span>] = sample &gt;&gt; <span class="number">16</span>;</span><br><span class="line">    <span class="comment">// tslint:disable-next-line:no-bitwise</span></span><br><span class="line">    reducedData[outputIndex + <span class="number">3</span>] = sample &gt;&gt; <span class="number">24</span>;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">case</span> <span class="number">3</span>: <span class="comment">// 24 bits signed</span></span><br><span class="line">    sample = sample * <span class="number">8388607.5</span> - <span class="number">0.5</span>;</span><br><span class="line">    reducedData[outputIndex] = sample;</span><br><span class="line">    <span class="comment">// tslint:disable-next-line:no-bitwise</span></span><br><span class="line">    reducedData[outputIndex + <span class="number">1</span>] = sample &gt;&gt; <span class="number">8</span>;</span><br><span class="line">    <span class="comment">// tslint:disable-next-line:no-bitwise</span></span><br><span class="line">    reducedData[outputIndex + <span class="number">2</span>] = sample &gt;&gt; <span class="number">16</span>;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">case</span> <span class="number">2</span>: <span class="comment">// 16 bits signed</span></span><br><span class="line">    sample = sample * <span class="number">32767.5</span> - <span class="number">0.5</span>;</span><br><span class="line">    reducedData[outputIndex] = sample;</span><br><span class="line">    <span class="comment">// tslint:disable-next-line:no-bitwise</span></span><br><span class="line">    reducedData[outputIndex + <span class="number">1</span>] = sample &gt;&gt; <span class="number">8</span>;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">case</span> <span class="number">1</span>: <span class="comment">// 8 bits unsigned</span></span><br><span class="line">    reducedData[outputIndex] = (sample + <span class="number">1</span>) * <span class="number">127.5</span>;</span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>

<h3 id="HTTPS-vs-HTTP"><a href="#HTTPS-vs-HTTP" class="headerlink" title="HTTPS vs HTTP"></a>HTTPS vs HTTP</h3><p>获取麦克风权限时需要 https 协议下验证，如何能在 http 网站情况下也可以获取<a href="https://support.scandit.com/hc/en-us/articles/360002743551-Do-I-really-need-to-serve-my-site-with-https-">权限</a>。</p>
<blockquote>
<p>chrome:&#x2F;&#x2F;flags&#x2F;#unsafely-treat-insecure-origin-as-secure</p>
</blockquote>
<p>本地服务 iOS wss 连接断开问题，<a href="https://stackoverflow.com/questions/37898048/websocket-network-error-osstatus-error-9807-invalid-certificate-chain/42148960">需要开启指定的新特性</a></p>
<blockquote>
<p>Settings（设置） &gt; Safari &gt; Advanced（高级） &gt; Experimental Features &gt; NSURLSession Websocket</p>
</blockquote>
<h3 id="设备兼容情况"><a href="#设备兼容情况" class="headerlink" title="设备兼容情况"></a>设备兼容情况</h3><p>Android WebView 和 Chrome 支持程度较好，Mac 和 iOS Safari 支持系统版本 11 及以上，<strong>iOS WKWebView 支持系统版本 14.3 及以上（iOS 微信内置浏览器和小程序 web-view 使用的是 WKWebView）</strong>。</p>
<p><img src="/images/web-audio/getUserMedia.jpeg" alt="getUserMedia"></p>
<h2 id="音频播放"><a href="#音频播放" class="headerlink" title="音频播放"></a>音频播放</h2><p>下一步，需要了解采集后得到的 PCM 是如何播放：PCM 是无法直接播放的，需要给 PCM <strong>添加 wav 头部</strong>，才能通过 AudioContext 转换为 AudioBuffer 播放。</p>
<h3 id="转换"><a href="#转换" class="headerlink" title="转换"></a>转换</h3><p>wav 格式是一种无损格式，是依据规范在 pcm 数据前添加 <strong>44</strong> 个__字节__长度用来填充一些声明信息的。wav 头部有 44 个字节，具体对应如下：</p>
<p><img src="/images/web-audio/wav-header.png" alt="wav 头部"></p>
<details>
<summary>如何添加 wav 头部代码</summary>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">public <span class="title function_">generateWavHeader</span>(<span class="attr">options</span>: <span class="title class_">IWavHeaderOptions</span>): <span class="title class_">ArrayBuffer</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123;</span><br><span class="line">    numFrames = originArrayBuffer.<span class="property">byteLength</span>, <span class="comment">// originArrayBuffer 为源 PCM</span></span><br><span class="line">    numChannels = <span class="number">1</span>,</span><br><span class="line">    sampleRate = <span class="number">16000</span>,</span><br><span class="line">    bytesPerSample = <span class="number">2</span></span><br><span class="line">  &#125; = options;</span><br><span class="line">  <span class="keyword">const</span> blockAlign = numChannels * bytesPerSample;</span><br><span class="line">  <span class="keyword">const</span> byteRate = sampleRate * blockAlign;</span><br><span class="line">  <span class="keyword">const</span> chunkSize = (numFrames <span class="keyword">as</span> number) * blockAlign;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> buffer = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">44</span>);</span><br><span class="line">  <span class="keyword">const</span> dataview = <span class="keyword">new</span> <span class="title class_">DataView</span>(buffer);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> position = <span class="number">0</span>;</span><br><span class="line">  position = <span class="variable language_">this</span>.<span class="title function_">dataviewWriteString</span>(dataview, <span class="string">&#x27;RIFF&#x27;</span>, position); <span class="comment">// ChunkID</span></span><br><span class="line">  position = <span class="variable language_">this</span>.<span class="title function_">dataviewWriteUint32</span>(dataview, chunkSize + <span class="number">36</span>, position); <span class="comment">// ChunkSize</span></span><br><span class="line">  position = <span class="variable language_">this</span>.<span class="title function_">dataviewWriteString</span>(dataview, <span class="string">&#x27;WAVE&#x27;</span>, position); <span class="comment">// Format</span></span><br><span class="line">  position = <span class="variable language_">this</span>.<span class="title function_">dataviewWriteString</span>(dataview, <span class="string">&#x27;fmt &#x27;</span>, position); <span class="comment">// Subchunk1ID</span></span><br><span class="line">  position = <span class="variable language_">this</span>.<span class="title function_">dataviewWriteUint32</span>(dataview, <span class="number">16</span>, position); <span class="comment">// Subchunk1Size</span></span><br><span class="line">  position = <span class="variable language_">this</span>.<span class="title function_">dataviewWriteUint16</span>(dataview, <span class="number">1</span>, position); <span class="comment">// AudioFormat</span></span><br><span class="line">  position = <span class="variable language_">this</span>.<span class="title function_">dataviewWriteUint16</span>(dataview, numChannels, position); <span class="comment">// NumChannels</span></span><br><span class="line">  position = <span class="variable language_">this</span>.<span class="title function_">dataviewWriteUint32</span>(dataview, sampleRate, position); <span class="comment">// SampleRate</span></span><br><span class="line">  position = <span class="variable language_">this</span>.<span class="title function_">dataviewWriteUint32</span>(dataview, byteRate, position); <span class="comment">// ByteRate</span></span><br><span class="line">  position = <span class="variable language_">this</span>.<span class="title function_">dataviewWriteUint16</span>(dataview, blockAlign, position); <span class="comment">// BlockAlign</span></span><br><span class="line">  position = <span class="variable language_">this</span>.<span class="title function_">dataviewWriteUint16</span>(dataview, bytesPerSample * <span class="number">8</span>, position); <span class="comment">// BitsPerSample</span></span><br><span class="line">  position = <span class="variable language_">this</span>.<span class="title function_">dataviewWriteString</span>(dataview, <span class="string">&#x27;data&#x27;</span>, position); <span class="comment">// Subchunk2ID</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">dataviewWriteUint32</span>(dataview, chunkSize, position); <span class="comment">//  Subchunk2Size</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> buffer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public <span class="title function_">concatArrayBuffer</span>(...<span class="attr">buffers</span>: <span class="title class_">ArrayBuffer</span>[]): <span class="title class_">ArrayBuffer</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> newBufferLength = buffers.<span class="title function_">reduce</span>(<span class="function">(<span class="params">total, buffer</span>) =&gt;</span> &#123;</span><br><span class="line">    total += buffer.<span class="property">byteLength</span>;</span><br><span class="line">    <span class="keyword">return</span> total;</span><br><span class="line">  &#125;, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">const</span> newBuffer = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(newBufferLength);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> bufferIndex = <span class="number">0</span>;</span><br><span class="line">  buffers.<span class="title function_">forEach</span>(<span class="function">(<span class="params">buffer</span>) =&gt;</span> &#123;</span><br><span class="line">    newBuffer.<span class="title function_">set</span>(<span class="keyword">new</span> <span class="title class_">Uint8Array</span>(buffer), bufferIndex);</span><br><span class="line">    bufferIndex += buffer.<span class="property">byteLength</span>;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> newBuffer.<span class="property">buffer</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private <span class="title function_">dataviewWriteString</span>(</span><br><span class="line">  <span class="attr">dataview</span>: <span class="title class_">DataView</span>,</span><br><span class="line">  <span class="attr">str</span>: string,</span><br><span class="line">  <span class="attr">position</span>: number</span><br><span class="line">): number &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; str.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    dataview.<span class="title function_">setUint8</span>(position + i, str.<span class="title function_">charCodeAt</span>(i));</span><br><span class="line">  &#125;</span><br><span class="line">  position += str.<span class="property">length</span>;</span><br><span class="line">  <span class="keyword">return</span> position;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private <span class="title function_">dataviewWriteUint32</span>(</span><br><span class="line">  <span class="attr">dataview</span>: <span class="title class_">DataView</span>,</span><br><span class="line">  <span class="attr">num</span>: number,</span><br><span class="line">  <span class="attr">position</span>: number</span><br><span class="line">): number &#123;</span><br><span class="line">  dataview.<span class="title function_">setUint32</span>(position, num, <span class="literal">true</span>);</span><br><span class="line">  position += <span class="number">4</span>;</span><br><span class="line">  <span class="keyword">return</span> position;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private <span class="title function_">dataviewWriteUint16</span>(</span><br><span class="line">  <span class="attr">dataview</span>: <span class="title class_">DataView</span>,</span><br><span class="line">  <span class="attr">num</span>: number,</span><br><span class="line">  <span class="attr">position</span>: number</span><br><span class="line">): number &#123;</span><br><span class="line">  dataview.<span class="title function_">setUint16</span>(position, num, <span class="literal">true</span>);</span><br><span class="line">  position += <span class="number">2</span>;</span><br><span class="line">  <span class="keyword">return</span> position;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</details>

<p>通过浏览器打印日志或者通过记事本打开 WAV 格式的音频 可以发现：</p>
<p><img src="/images/web-audio/arrayBuffer.png" alt="wav 头部"></p>
<p>WAV文件格式的结构组成，对该内容进行分析如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">52</span> <span class="number">49</span> <span class="number">46</span> <span class="number">46</span>（<span class="title class_">ChunkID</span>，<span class="number">4</span> 字节） = ‘<span class="variable constant_">RIFF</span>’</span><br><span class="line"></span><br><span class="line"><span class="number">24</span> <span class="number">42</span> <span class="number">04</span> <span class="number">00</span> （<span class="title class_">ChunkSize</span>，<span class="number">4</span> 字节）=  <span class="number">279076</span>  = <span class="number">279084</span> - <span class="number">8</span></span><br><span class="line"></span><br><span class="line"><span class="number">57</span> <span class="number">41</span> <span class="number">56</span> <span class="number">45</span> （<span class="title class_">Format</span>，<span class="number">4</span> 字节） = ‘<span class="variable constant_">WAVE</span>’</span><br><span class="line"></span><br><span class="line"><span class="number">66</span> 6D <span class="number">74</span> <span class="number">20</span> （<span class="title class_">Subchunk1ID</span>，<span class="number">4</span> 字节） = ‘fmt ’</span><br><span class="line"></span><br><span class="line"><span class="number">10</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> (<span class="title class_">Subchunk1</span> <span class="title class_">Size</span>，<span class="number">4</span> 字节) = <span class="number">16</span></span><br><span class="line"></span><br><span class="line"><span class="number">01</span> <span class="number">00</span>（<span class="title class_">AudioFormate</span>，<span class="number">2</span> 字节） = 音频格式 = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="number">01</span> <span class="number">00</span> （<span class="title class_">NumChannels</span>，<span class="number">2</span> 字节）= 声道数 = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="number">80</span> 3E <span class="number">00</span> <span class="number">00</span>（<span class="title class_">SampleRate</span>，<span class="number">4</span> 字节）= 采样率 = <span class="number">16000</span></span><br><span class="line"></span><br><span class="line"><span class="number">00</span> 7D <span class="number">00</span> <span class="number">00</span>（<span class="title class_">ByteRate</span>，<span class="number">4</span> 字节）= 字节率 = <span class="number">32000</span> = <span class="number">16000</span> * <span class="number">16</span> / <span class="number">8</span></span><br><span class="line"></span><br><span class="line"><span class="number">02</span> <span class="number">00</span> （<span class="title class_">BlockAlign</span>，<span class="number">2</span> 字节）= 内存对齐 = <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="number">10</span> <span class="number">00</span> （<span class="title class_">BitsPerSample</span>）= 每个样本的位深度 =  <span class="number">16</span></span><br><span class="line"></span><br><span class="line"><span class="number">64</span> <span class="number">61</span> <span class="number">74</span> <span class="number">61</span>（<span class="title class_">Subchunk2ID</span>，<span class="number">4</span> 字节） = ‘data’</span><br><span class="line"></span><br><span class="line"><span class="number">00</span> <span class="number">42</span> <span class="number">04</span> <span class="number">00</span> (<span class="title class_">Subchunk2</span> <span class="title class_">Size</span>，<span class="number">4</span> 字节) = 音频<span class="variable constant_">PCM</span>数据大小 = <span class="number">279040</span> = <span class="number">279084</span> - <span class="number">44</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/web-audio/wav-header-detail.jpeg" alt="wav 头部分析"></p>
<p>可以通过 <code>file</code> 命令查看 wav 头部简要信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$file</span> test.wav</span><br></pre></td></tr></table></figure>

<p><img src="/images/web-audio/wav-file-detail.png" alt="wav-file"></p>
<h3 id="解码-decode"><a href="#解码-decode" class="headerlink" title="解码(decode)"></a>解码(decode)</h3><p>通过 <code>AudioContext</code> 的 <code>decodeAudioData</code> API 解码 wav 文件中的 ArrayBuffer，转换为 Audiobuffer。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">playWav</span>(<span class="params">wavBuffer: <span class="built_in">ArrayBuffer</span></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="title class_">AudioContext</span> = <span class="variable language_">window</span>.<span class="property">AudioContext</span> || <span class="variable language_">window</span>.<span class="property">webkitAudioContext</span>;</span><br><span class="line">  <span class="keyword">const</span> audioCtx = <span class="keyword">new</span> <span class="title class_">AudioContext</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Safari 不支持 decodeAudioData promise 模式</span></span><br><span class="line">  audioCtx.<span class="title function_">decodeAudioData</span>(</span><br><span class="line">    wavBuffer,</span><br><span class="line">    <span class="function">(<span class="params">audioBuffer</span>) =&gt;</span> &#123;&#125;,</span><br><span class="line">    <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;&#125;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="降噪（消除毛刺）"><a href="#降噪（消除毛刺）" class="headerlink" title="降噪（消除毛刺）"></a>降噪（消除毛刺）</h3><p>播放短小的 Audiobuffer 时开始和结束可能会有细微的噪音出现，其中<a href="https://stackoverflow.com/questions/53100047/why-state-can-be-invalid-in-web-audio-in-safari-after-resume">降噪</a>的方法如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">deNoising</span>(<span class="params">buffer: AudioBuffer</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> fixRange = <span class="number">100</span>; <span class="comment">// 该数值根据情况调整</span></span><br><span class="line">  <span class="keyword">const</span> audioBufferArray = buffer.<span class="title function_">getChannelData</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">const</span> length = audioBufferArray.<span class="property">length</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; fixRange; i++) &#123;</span><br><span class="line">    audioBufferArray[i] = (audioBufferArray[i] * i) / fixRange; <span class="comment">// fade in</span></span><br><span class="line">    audioBufferArray[length - i - <span class="number">1</span>] =</span><br><span class="line">      (audioBufferArray[length - i - <span class="number">1</span>] * i) / fixRange; <span class="comment">// fade out</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="播放"><a href="#播放" class="headerlink" title="播放"></a>播放</h3><p>通过 createBufferSource() 方法用于创建一个新的 <code>AudioBufferSourceNode</code> 接口, 该接口可以通过 AudioBuffer 对象来播放音频数据。再连接到 AudioContext 中所有音频（节点）的最终目标节点，一般是音频渲染设备，比如扬声器。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">play</span>(<span class="params">buffer: AudioBuffer</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="title class_">AudioContext</span> = <span class="variable language_">window</span>.<span class="property">AudioContext</span> || <span class="variable language_">window</span>.<span class="property">webkitAudioContext</span>;</span><br><span class="line">  <span class="keyword">const</span> audioCtx = <span class="keyword">new</span> <span class="title class_">AudioContext</span>();</span><br><span class="line">  <span class="keyword">const</span> source = audioCtx.<span class="title function_">createBufferSource</span>();</span><br><span class="line"></span><br><span class="line">  source.<span class="property">buffer</span> = buffer;</span><br><span class="line">  source.<span class="title function_">connect</span>(audioCtx.<span class="property">destination</span>);</span><br><span class="line">  source.<span class="title function_">start</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="PCM-播放工具"><a href="#PCM-播放工具" class="headerlink" title="PCM 播放工具"></a>PCM 播放工具</h3><p>音频混音器：<a href="https://www.audacityteam.org/">Audacity</a></p>
<p><img src="/images/web-audio/audacity.png" alt="audacity"></p>
<h2 id="ArrayBuffer"><a href="#ArrayBuffer" class="headerlink" title="ArrayBuffer"></a>ArrayBuffer</h2><p><code>ArrayBuffer</code> 对象用来表示通用的、<em>固定长度</em>的__原始二进制数据缓冲区__（预分配内存）。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> buffer = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">16</span>); <span class="comment">// 16 字节长度的 ArrayBuffer</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(buffer.<span class="property">byteLength</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li>单位是__字节__，它是一个字节数组，通常在其他语言中称为 byte array</li>
<li>不能__直接操作__ <code>ArrayBuffer</code> 的内容，只能通过 DataView 或者定型数组对象操作</li>
<li>ArrayBuffer 分配的内存__不能超过__ Number.MAX_SAFE_INTEGER(2^53 - 1) 字节</li>
</ul>
<h3 id="DataView"><a href="#DataView" class="headerlink" title="DataView"></a>DataView</h3><p><code>DataView</code> 视图是一个可以从二进制 <em>ArrayBuffer</em> 对象中读写多种数值类型的底层接口，使用它时不用考虑不同平台的<code>字节序</code>问题。</p>
<blockquote>
<p>必须在对已有的 ArrayBuffer 读取或写入时才能创建 DataView 实例。</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> buffer = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> dataview = <span class="keyword">new</span> <span class="title class_">DataView</span>(buffer);</span><br><span class="line">dataview.<span class="title function_">setUint8</span>(<span class="number">0</span>, <span class="number">255</span>);</span><br><span class="line">dataview.<span class="title function_">setUint8</span>(<span class="number">1</span>, <span class="number">0xff</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(dataview.<span class="property">byteOffset</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(dataview.<span class="property">byteLength</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(dataview.<span class="property">buffer</span> === buffer); <span class="comment">// DataViiew 维护着对该缓冲实例的引用</span></span><br></pre></td></tr></table></figure>

<p>要通过 DataView 读取缓冲，还需要以下几点：</p>
<ul>
<li>首先是要读或者写的字节偏移量。可以看出 DataView 中的某种“地址”</li>
<li>DataView 应该使用 ElementType 来实现 Javascript 的 Number 类型到缓冲内二进制格式的转换</li>
<li>最后是内存中值的字节序。默认为大端字节序</li>
</ul>
<h3 id="定型数组"><a href="#定型数组" class="headerlink" title="定型数组"></a>定型数组</h3><p><img src="/images/web-audio/dataview-type.jpeg" alt="DataView Element Type"></p>
<h3 id="字节序"><a href="#字节序" class="headerlink" title="字节序"></a>字节序</h3><p><a href="https://developer.mozilla.org/zh-CN/docs/Glossary/Endianness">字节序</a>，或字节顺序（”Endian”、”endianness” 或 “byte-order”），描述了计算机如何组织字节，组成对应的数字。</p>
<p>每一个字节可以存储一个 8 位（bit）的数字（0x00-0xff），存储更大数字需要多个字节，现在大部分需占用多字节的数字排列方式是 little-endian（低位字节排放在内存中低地址端，高字节排放在内存的高地址端），与 big-endian 相反。</p>
<p>举例：用不同字节序存储数字 <code>0x12345678</code>(即十进制中的 305 419 896)</p>
<ul>
<li>little-endian：<code>0x78 0x56 0x34 0x12</code></li>
<li>big-endian：<code>0x12 0x34 0x56 0x78</code></li>
</ul>
<h2 id="问题总结"><a href="#问题总结" class="headerlink" title="问题总结"></a>问题总结</h2><p>总结下处理音频时遇到的问题：iOS 和 Safari 问题就是特别多。</p>
<h3 id="iOS-Q-A"><a href="#iOS-Q-A" class="headerlink" title="iOS Q&amp;A"></a>iOS Q&amp;A</h3><h4 id="1-Safari-调用-AudioContext-的次数有限"><a href="#1-Safari-调用-AudioContext-的次数有限" class="headerlink" title="1. Safari 调用 AudioContext 的次数有限"></a>1. Safari 调用 AudioContext 的次数有限</h4><p>问题：多次生成 AudioContext 实例会报错 <code>null is not an object</code></p>
<p>方案：销毁  AudioContext 实例</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">AudioContext</span>.<span class="title function_">close</span>(); <span class="comment">// 关闭一个音频环境, 释放任何正在使用系统资源的音频.</span></span><br></pre></td></tr></table></figure>

<h4 id="2-Safari-不支持-AudioContext-decodeAudio-Promise"><a href="#2-Safari-不支持-AudioContext-decodeAudio-Promise" class="headerlink" title="2. Safari 不支持 AudioContext.decodeAudio Promise"></a>2. Safari 不支持 AudioContext.decodeAudio Promise</h4><p>问题：AudioContext.decodeAudio Promise Safari 下会报错</p>
<p>方案：直接使用回调函数，不使用 Promise</p>
<h4 id="3-iOS-AudioContext-播放没有声音"><a href="#3-iOS-AudioContext-播放没有声音" class="headerlink" title="3. iOS AudioContext 播放没有声音"></a>3. iOS AudioContext 播放没有声音</h4><p>问题：点击 Audio 标签播放有声音，AudioContext 播放没有声音</p>
<p>方案：检查后发现 AudioContext 在 iOS 静音模式下无法播放声音，其次判断 AudioContext 是否处于 running 状态，否则调用</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">audioContext.<span class="title function_">resume</span>();</span><br></pre></td></tr></table></figure>

<h4 id="4-iOS-Safari-不触发-canplaythrough-事件"><a href="#4-iOS-Safari-不触发-canplaythrough-事件" class="headerlink" title="4. iOS Safari 不触发 canplaythrough 事件"></a>4. iOS Safari 不触发 canplaythrough 事件</h4><p>问题：iOS Audio 标签加载资源后 Safari 不触发 canplaythrough 事件</p>
<p>方案：设置 src 后调用 load 方法（iOS 14 及以上）</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> audio = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;AUDIO&#x27;</span>);</span><br><span class="line">audio.<span class="title function_">addEventListener</span>(<span class="string">&#x27;canplaythrough&#x27;</span>, loadedVideo, <span class="literal">false</span>);</span><br><span class="line">audio.<span class="property">src</span> = url;</span><br><span class="line">audio.<span class="title function_">load</span>(); <span class="comment">// 关键代码</span></span><br></pre></td></tr></table></figure>

<h4 id="5-iOS-Safari-显示播放时间不正确"><a href="#5-iOS-Safari-显示播放时间不正确" class="headerlink" title="5. iOS Safari 显示播放时间不正确"></a>5. iOS Safari 显示播放时间不正确</h4><p>问题：iOS Safari Audio 标签加载资源后显示的时间长度不正确</p>
<p>方案：头部部分字段值不正确</p>
<h4 id="6-iPad-14-8-播放时间不正确"><a href="#6-iPad-14-8-播放时间不正确" class="headerlink" title="6. iPad 14.8 播放时间不正确"></a>6. iPad 14.8 播放时间不正确</h4><p>问题：iPad 14.8 AudioContext 播放的时间跟理论上（source.buffer.duration 或者 arraybuffer&#x2F;samplerate&#x2F;2）计算的时间不一致，实际上播放时间更短</p>
<p>方案：使用 source.onended 监听回调函数替代</p>
<p>最后寄语：WebRTC 和 FFmpeg 太多要学习的，后续再进一步研究。</p>
<p>参考文章：</p>
<p><a href="https://www.cnblogs.com/yongdaimi/p/10722355.html">音频属性相关：声道、采样率、采样位数、样本格式、比特率</a></p>
<p><a href="https://rtcdeveloper.com/t/topic/21480">让音视频学习变得简单之音频深度学习</a></p>
<p><a href="https://www.cnblogs.com/dashnowords/p/11795251.html">WebRTC在浏览器中如何获得指定格式的PCM数据</a></p>
<p><a href="http://soundfile.sapp.org/doc/WaveFormat/">WAVE PCM soundfile format</a></p>
<p><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/ArrayBuffer">ArrayBuffer MDN</a></p>
<p>Javascript 高级程序设计（第四版）：定型数组</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://zeuscoder.github.io/2021/06/27/web-audio/" data-id="clvynbzq5002fazc9094mh663" class="article-share-link">
        分享
      </a>
      
    </footer>

  </div>

  
  
<nav class="article-nav">
  
  <a href="/2021/11/23/nginx-error/" class="article-nav-link">
    <strong class="article-nav-caption">前一篇</strong>
    <div class="article-nav-title">
      
      DevOps：Nginx 部署的一个有趣问题
      
    </div>
  </a>
  
  
  <a href="/2021/02/20/js-function-programming/" class="article-nav-link">
    <strong class="article-nav-caption">后一篇</strong>
    <div class="article-nav-title">JS：函数式编程小结</div>
  </a>
  
</nav>

  

  
  
  
  

</article>
</section>
    <footer class="footer">
  <div class="outer">
    <div class="float-right">
      <ul class="list-inline">
  
  <li><i class="fe fe-smile-alt"></i> <span id="busuanzi_value_site_uv"></span></li>
  
  <li><i class="fe fe-bookmark"></i> <span id="busuanzi_value_page_pv"></span></li>
  
</ul>
    </div>
    <ul class="list-inline">
      <li>zeus の blog &copy; 2024</li>
      
        <li></li>
      
      <li>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a></li>
      <li>theme  <a href="https://github.com/zhwangart/hexo-theme-ocean">Ocean</a></li>
    </ul>
  </div>
</footer>
  </main>
  <aside class="sidebar">
    <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/zeus.png" alt="zeus の blog"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/gallery">相册</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/about">关于</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link nav-item-search" title="搜索">
        <i class="fe fe-search"></i>
        搜索
      </a>
    </li>
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      <div class="totop" id="totop">
  <i class="fe fe-rocket"></i>
</div>
    </li>
    <li class="nav-item">
      
      <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
        <i class="fe fe-feed"></i>
      </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
  </aside>
  
<script src="/js/jquery-2.0.3.min.js"></script>


<script src="/js/jquery.justifiedGallery.min.js"></script>


<script src="/js/lazyload.min.js"></script>


<script src="/js/busuanzi-2.3.pure.min.js"></script>



<script src="/js/wrapImage.js"></script>


<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/copybtn.js"></script>





<script src="/js/tocbot.min.js"></script>

<script>
  // Tocbot_v4.7.0  http://tscanlin.github.io/tocbot/
  tocbot.init({
    tocSelector: '.tocbot',
    contentSelector: '.article-entry',
    headingSelector: 'h1, h2, h3, h4, h5, h6',
    hasInnerContainers: true,
    scrollSmooth: true,
    positionFixedSelector: '.tocbot',
    positionFixedClass: 'is-position-fixed',
    fixedSidebarOffset: 'auto',
  });
</script>



<script src="/js/ocean.js"></script>

</body>

</html>