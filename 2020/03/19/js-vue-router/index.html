<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  
  
  
  <meta name="description" content="穷则独善其身">
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>
    JS：浅析 Vue-Router |
    
    zeus の blog</title>
  
  <link rel="shortcut icon" href="/zeus.ico">
  
  
<link rel="stylesheet" href="/css/style.css">

  
  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<script src="/js/pace.min.js"></script>

<meta name="generator" content="Hexo 7.2.0"></head>

<body>
  <main class="content">
    <section class="outer">
  <article id="post-js-vue-router" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
      

<h1 class="article-title" itemprop="name">
  JS：浅析 Vue-Router
</h1>



    </header>
    

    
    <div class="article-meta">
      <a href="/2020/03/19/js-vue-router/" class="article-date">
  <time datetime="2020-03-19T15:25:03.000Z" itemprop="datePublished">2020-03-19</time>
</a>
      
    </div>
    

    
    
<div class="tocbot"></div>

    

    <div class="article-entry" itemprop="articleBody">
      
      
      
      <p><a href="https://router.vuejs.org/zh/">Vue Router</a> 是 Vue.js 构建单页面应用的路由管理器库，支持 <strong>hash</strong>、<strong>history</strong>、<strong>abstract</strong> 3种路由方式，提供了 <strong>&lt;router-view&gt;</strong> 和 <strong>&lt;router-link&gt;</strong> 2种组件。</p>
<span id="more"></span>

<p>基本使用例子：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Hello App!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 使用 router-link 组件来导航. --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 通过传入 `to` 属性指定链接. --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- &lt;router-link&gt; 默认会被渲染成一个 `&lt;a&gt;` 标签 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">router-link</span> <span class="attr">to</span>=<span class="string">&quot;/foo&quot;</span>&gt;</span>Go to Foo<span class="tag">&lt;/<span class="name">router-link</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">router-link</span> <span class="attr">to</span>=<span class="string">&quot;/bar&quot;</span>&gt;</span>Go to Bar<span class="tag">&lt;/<span class="name">router-link</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 路由出口 --&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 路由匹配到的组件将渲染在这里 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">router-view</span>&gt;</span><span class="tag">&lt;/<span class="name">router-view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">Vue</span> <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">VueRouter</span> <span class="keyword">from</span> <span class="string">&#x27;vue-router&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">App</span> <span class="keyword">from</span> <span class="string">&#x27;./App&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">Vue</span>.<span class="title function_">use</span>(<span class="title class_">VueRouter</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. 定义路由</span></span><br><span class="line"><span class="comment">// 每个路由应该映射一个组件。 其中&quot;component&quot; 可以是</span></span><br><span class="line"><span class="comment">// 通过 Vue.extend() 创建的组件构造器，</span></span><br><span class="line"><span class="comment">// 或者，只是一个组件配置对象。</span></span><br><span class="line"><span class="keyword">const</span> routes = [</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;/foo&#x27;</span>, <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="string">&#x27;./foo.vue&#x27;</span>) &#125;,</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;/bar&#x27;</span>, <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="string">&#x27;./bar.vue&#x27;</span>) &#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 创建 router 实例，然后传 `routes` 配置</span></span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> <span class="title class_">VueRouter</span>(&#123;</span><br><span class="line">  routes</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 创建和挂载根实例</span></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Vue</span>(&#123;</span><br><span class="line">  <span class="attr">el</span>: <span class="string">&#x27;#app&#x27;</span>,</span><br><span class="line">  <span class="title function_">render</span>(<span class="params">h</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">h</span>(<span class="title class_">App</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">  router <span class="comment">// 记得要通过 router 配置参数注入路由，从而让整个应用都有路由功能</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>分析源码时会涉及不少辅助函数，无需详细分析其函数，只需要通过 <em>test&#x2F;unit&#x2F;specs</em> 中的断言了解该辅助函数的作用输出即可。</p>
</blockquote>
<h4 id="路由注册"><a href="#路由注册" class="headerlink" title="路由注册"></a>路由注册</h4><p>使用 <code>Vue.use(VueRouter)</code> 其实是主动调用 <code>VueRouter</code> 的 <strong>install</strong> 方法。</p>
<p>install 源代码：<em>src&#x2F;install.js</em></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">install</span> (<span class="title class_">Vue</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">isDef</span> = v =&gt; v !== <span class="literal">undefined</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">registerInstance</span> = (<span class="params">vm, callVal</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> i = vm.<span class="property">$options</span>.<span class="property">_parentVnode</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isDef</span>(i) &amp;&amp; <span class="title function_">isDef</span>(i = i.<span class="property">data</span>) &amp;&amp; <span class="title function_">isDef</span>(i = i.<span class="property">registerRouteInstance</span>)) &#123;</span><br><span class="line">      <span class="title function_">i</span>(vm, callVal)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title class_">Vue</span>.<span class="title function_">mixin</span>(&#123;</span><br><span class="line">    beforeCreate () &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_">isDef</span>(<span class="variable language_">this</span>.<span class="property">$options</span>.<span class="property">router</span>)) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">_routerRoot</span> = <span class="variable language_">this</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">_router</span> = <span class="variable language_">this</span>.<span class="property">$options</span>.<span class="property">router</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">_router</span>.<span class="title function_">init</span>(<span class="variable language_">this</span>)</span><br><span class="line">        <span class="title class_">Vue</span>.<span class="property">util</span>.<span class="title function_">defineReactive</span>(<span class="variable language_">this</span>, <span class="string">&#x27;_route&#x27;</span>, <span class="variable language_">this</span>.<span class="property">_router</span>.<span class="property">history</span>.<span class="property">current</span>)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">_routerRoot</span> = (<span class="variable language_">this</span>.<span class="property">$parent</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">$parent</span>.<span class="property">_routerRoot</span>) || <span class="variable language_">this</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="title function_">registerInstance</span>(<span class="variable language_">this</span>, <span class="variable language_">this</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">    destroyed () &#123;</span><br><span class="line">      <span class="title function_">registerInstance</span>(<span class="variable language_">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(<span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>, <span class="string">&#x27;$router&#x27;</span>, &#123;</span><br><span class="line">    get () &#123; <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">_routerRoot</span>.<span class="property">_router</span> &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(<span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>, <span class="string">&#x27;$route&#x27;</span>, &#123;</span><br><span class="line">    get () &#123; <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">_routerRoot</span>.<span class="property">_route</span> &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="title class_">Vue</span>.<span class="title function_">component</span>(<span class="string">&#x27;RouterView&#x27;</span>, <span class="title class_">View</span>)</span><br><span class="line">  <span class="title class_">Vue</span>.<span class="title function_">component</span>(<span class="string">&#x27;RouterLink&#x27;</span>, <span class="title class_">Link</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 跟 created 一样的合并策略</span></span><br><span class="line">  <span class="keyword">const</span> strats = <span class="title class_">Vue</span>.<span class="property">config</span>.<span class="property">optionMergeStrategies</span></span><br><span class="line">  <span class="comment">// use the same hook merging strategy for route hooks</span></span><br><span class="line">  strats.<span class="property">beforeRouteEnter</span> = strats.<span class="property">beforeRouteLeave</span> = strats.<span class="property">beforeRouteUpdate</span> = strats.<span class="property">created</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>首先利用 <code>Vue.mixin</code> 在每个组件中的 <code>beforeCreate</code> 和 <code>destroyed</code> 钩子函数中注入实例。</li>
<li>接着在 Vue 原型上定义了 <code>$router</code> 和 <code>$route</code> 2个属性的 get 方法，也就是 <code>this.$router</code> 和 <code>this.$route</code>。</li>
<li>然后通过 <code>Vue.component</code> 定义 <code>&lt;router-view&gt;</code> 和 <code>&lt;router-link&gt;</code> 两个组件。</li>
<li>最后定义路由中 <code>beforeRouteEnter</code>、<code>beforeRouteLeave</code>、<code>beforeRouteUpdate</code> 等钩子函数的合并策略，和普通的钩子函数一样。</li>
</ul>
<h4 id="VueRouter"><a href="#VueRouter" class="headerlink" title="VueRouter"></a>VueRouter</h4><p>Vue-router 的入口文件是 <em>src&#x2F;index.js</em>, 声明了 <strong>VueRouter</strong> 类，也实现了 <strong>install</strong> 的静态方法：<code>VueRouter.install = install</code>。</p>
<p>VueRouter 源代码：<em>src&#x2F;index.js</em></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// VueRouter</span></span><br><span class="line"><span class="title function_">constructor</span> (<span class="attr">options</span>: <span class="title class_">RouterOptions</span> = &#123;&#125;) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">app</span> = <span class="literal">null</span> <span class="comment">// 根 Vue 实例</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">apps</span> = [] <span class="comment">// 持有 $options.router 属性的 Vue 实例</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">options</span> = options <span class="comment">// 路由配置</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">beforeHooks</span> = [] <span class="comment">// 全局 beforeEach</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">resolveHooks</span> = [] <span class="comment">// 全局 beforeResolve</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">afterHooks</span> = [] <span class="comment">// 全局 afterEach</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">matcher</span> = <span class="title function_">createMatcher</span>(options.<span class="property">routes</span> || [], <span class="variable language_">this</span>) <span class="comment">// 路由匹配器</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">mode</span> = options.<span class="property">mode</span> || <span class="string">&#x27;hash&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 以下都是继承了 History 基类</span></span><br><span class="line">    <span class="keyword">switch</span> (mode) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;history&#x27;</span>:</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">history</span> = <span class="keyword">new</span> <span class="title class_">HTML5History</span>(<span class="variable language_">this</span>, options.<span class="property">base</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;hash&#x27;</span>:</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">history</span> = <span class="keyword">new</span> <span class="title class_">HashHistory</span>(<span class="variable language_">this</span>, options.<span class="property">base</span>, <span class="variable language_">this</span>.<span class="property">fallback</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;abstract&#x27;</span>:</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">history</span> = <span class="keyword">new</span> <span class="title class_">AbstractHistory</span>(<span class="variable language_">this</span>, options.<span class="property">base</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>业务项目上调用 <code>const router = new VueRouter(&#123;routes&#125;)</code> 实例化 <code>VueRouter</code> 后会返回它的实例 <code>router</code>，再在 <code>const app = new Vue(&#123;router&#125;)</code> 时把 <code>router</code> 作为配置（$options）的属性传入，然后在 <code>install</code> 方法中 mixin 的 <code>beforeCreate</code> 函数使用：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">beforeCreate</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isDef</span>(<span class="variable language_">this</span>.<span class="property">$options</span>.<span class="property">router</span>)) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">_router</span> = <span class="variable language_">this</span>.<span class="property">$options</span>.<span class="property">router</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">_router</span>.<span class="title function_">init</span>(<span class="variable language_">this</span>)</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当 <code>new Vue</code> 根组件执行 <code>beforeCreate</code> 钩子函数的时候，如果传入了 <code>router</code> 实例，都会执行 <code>router.init</code> 方法初始化：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">init (<span class="attr">app</span>: any <span class="comment">/* Vue component instance */</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">apps</span>.<span class="title function_">push</span>(app) <span class="comment">// app 就是持有 $options.router 属性的 Vue 实例</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">app</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">app</span> = app</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> history = <span class="variable language_">this</span>.<span class="property">history</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (history <span class="keyword">instanceof</span> <span class="title class_">HTML5History</span>) &#123;</span><br><span class="line">      history.<span class="title function_">transitionTo</span>(history.<span class="title function_">getCurrentLocation</span>())</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (history <span class="keyword">instanceof</span> <span class="title class_">HashHistory</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> <span class="title function_">setupHashListener</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">        history.<span class="title function_">setupListeners</span>()</span><br><span class="line">      &#125;</span><br><span class="line">      history.<span class="title function_">transitionTo</span>(</span><br><span class="line">        history.<span class="title function_">getCurrentLocation</span>(),</span><br><span class="line">        setupHashListener,</span><br><span class="line">        setupHashListener</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    history.<span class="title function_">listen</span>(<span class="function"><span class="params">route</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">apps</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">app</span>) =&gt;</span> &#123;</span><br><span class="line">        app.<span class="property">_route</span> = route</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>init</code> 传入的 <code>app</code> 参数是根 <code>Vue</code> 实例，然后存储到 <code>this.apps</code> 中。再根据 history 类型执行 <code>history.transitionTo</code> 方法，该方法定义在 <code>History</code> 基类中。源代码：<em>src&#x2F;history&#x2F;base.js</em>：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 路由过渡</span></span><br><span class="line">transitionTo (<span class="attr">location</span>: <span class="title class_">RawLocation</span>, onComplete?: <span class="title class_">Function</span>, onAbort?: <span class="title class_">Function</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> route = <span class="variable language_">this</span>.<span class="property">router</span>.<span class="title function_">match</span>(location, <span class="variable language_">this</span>.<span class="property">current</span>)</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用 <code>this.router.match</code> 实际上是调用了 <code>this.matcher.match</code> 去做匹配。</p>
<h4 id="Matcher"><a href="#Matcher" class="headerlink" title="Matcher"></a>Matcher</h4><p>matcher 源代码：<em>src&#x2F;create-matcher.js</em></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> type <span class="title class_">Matcher</span> = &#123;</span><br><span class="line">    <span class="attr">match</span>: <span class="function">(<span class="params">raw: RawLocation, current?: Route, redirectedFrom?: Location</span>) =&gt;</span> <span class="title class_">Route</span>;</span><br><span class="line">    <span class="attr">addRoutes</span>: <span class="function">(<span class="params">routes: <span class="built_in">Array</span>&lt;RouteConfig&gt;</span>) =&gt;</span> <span class="keyword">void</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Matcher</code> 返回了2个方法：<code>match</code> 和 <code>adddRoutes</code>。</p>
<h5 id="createMatcher"><a href="#createMatcher" class="headerlink" title="createMatcher"></a>createMatcher</h5><p>在 <code>new VueRouter(&#123;routes&#125;)</code> 时, <code>VueRouter</code> 的 <code>constructor</code> 通过 <code>this.matcher = createMatcher(options.routes || [], this)</code> 创建 matcher。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">createMatcher</span> (</span><br><span class="line">  <span class="attr">routes</span>: <span class="title class_">Array</span>&lt;<span class="title class_">RouteConfig</span>&gt;,</span><br><span class="line">  <span class="attr">router</span>: <span class="title class_">VueRouter</span></span><br><span class="line">): <span class="title class_">Matcher</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; pathList, pathMap, nameMap &#125; = <span class="title function_">createRouteMap</span>(routes)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">addRoutes</span> (routes) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">match</span> (</span><br><span class="line">        <span class="attr">raw</span>: <span class="title class_">RawLocation</span>,</span><br><span class="line">        currentRoute?: <span class="title class_">Route</span>,</span><br><span class="line">        redirectedFrom?: <span class="title class_">Location</span></span><br><span class="line">    ): <span class="title class_">Route</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        match,</span><br><span class="line">        addRoutes</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><p><code>createMatcher</code> 接受了 2 个参数，一个是 <code>routes</code>，它是用户定义的路由配置，一个是 <code>router</code>，是 <code>new VueRouter</code> 时返回的实例 <code>this</code>。</p>
</li>
<li><p><code>const &#123; pathList, pathMap, nameMap &#125; = createRouteMap(routes)</code> 深度遍历 <code>routes</code> 创建了一个映射路由表，<code>pathList</code> 存储所有的 <code>path</code>，<code>pathMap</code> 表示一个 <code>path</code> 到 <code>RouteRecord</code> 的映射关系，而 <code>nameMap</code> 表示 <code>name</code> 到 <code>RouteRecord</code> 的映射关系。<code>RouteRecord</code> 的数据结构如下：</p>
</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// flow/declarations.js</span></span><br><span class="line">declare type <span class="title class_">RouteRecord</span> = &#123;</span><br><span class="line">    <span class="attr">path</span>: string;</span><br><span class="line">    <span class="attr">regex</span>: <span class="title class_">RouteRegExp</span>;</span><br><span class="line">    <span class="attr">components</span>: <span class="title class_">Dictionary</span>&lt;any&gt;;</span><br><span class="line">    <span class="attr">instances</span>: <span class="title class_">Dictionary</span>&lt;any&gt;;</span><br><span class="line">    <span class="attr">name</span>: ?string;</span><br><span class="line">    <span class="attr">parent</span>: ?<span class="title class_">RouteRecord</span>;</span><br><span class="line">    <span class="attr">redirect</span>: ?<span class="title class_">RedirectOption</span>;</span><br><span class="line">    <span class="attr">matchAs</span>: ?string;</span><br><span class="line">    <span class="attr">beforeEnter</span>: ?<span class="title class_">NavigationGuard</span>;</span><br><span class="line">    <span class="attr">meta</span>: any;</span><br><span class="line">    <span class="attr">props</span>: boolean | <span class="title class_">Object</span> | <span class="title class_">Function</span> | <span class="title class_">Dictionary</span>&lt;boolean | <span class="title class_">Object</span> | <span class="title class_">Function</span>&gt;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="addRoutes"><a href="#addRoutes" class="headerlink" title="addRoutes"></a>addRoutes</h5><p><code>addRoutes</code> 方法的作用是动态添加路由配置.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">addRoutes</span> (routes) &#123;</span><br><span class="line">    <span class="title function_">createRouteMap</span>(routes, pathList, pathMap, nameMap)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="match"><a href="#match" class="headerlink" title="match"></a>match</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">match</span> (</span><br><span class="line">    <span class="attr">raw</span>: <span class="title class_">RawLocation</span>,</span><br><span class="line">    currentRoute?: <span class="title class_">Route</span>,</span><br><span class="line">    redirectedFrom?: <span class="title class_">Location</span></span><br><span class="line">  ): <span class="title class_">Route</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> location = <span class="title function_">normalizeLocation</span>(raw, currentRoute, <span class="literal">false</span>, router)</span><br><span class="line">    <span class="keyword">const</span> &#123; name &#125; = location</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (name) &#123;</span><br><span class="line">        <span class="keyword">const</span> record = nameMap[name]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!record) <span class="keyword">return</span> <span class="title function_">_createRoute</span>(<span class="literal">null</span>, location)</span><br><span class="line">        <span class="keyword">const</span> paramNames = record.<span class="property">regex</span>.<span class="property">keys</span></span><br><span class="line">            .<span class="title function_">filter</span>(<span class="function"><span class="params">key</span> =&gt;</span> !key.<span class="property">optional</span>)</span><br><span class="line">            .<span class="title function_">map</span>(<span class="function"><span class="params">key</span> =&gt;</span> key.<span class="property">name</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> location.<span class="property">params</span> !== <span class="string">&#x27;object&#x27;</span>) &#123;</span><br><span class="line">            location.<span class="property">params</span> = &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (currentRoute &amp;&amp; <span class="keyword">typeof</span> currentRoute.<span class="property">params</span> === <span class="string">&#x27;object&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> currentRoute.<span class="property">params</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!(key <span class="keyword">in</span> location.<span class="property">params</span>) &amp;&amp; paramNames.<span class="title function_">indexOf</span>(key) &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">                    location.<span class="property">params</span>[key] = currentRoute.<span class="property">params</span>[key]</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        location.<span class="property">path</span> = <span class="title function_">fillParams</span>(record.<span class="property">path</span>, location.<span class="property">params</span>, <span class="string">`named route &quot;<span class="subst">$&#123;name&#125;</span>&quot;`</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">_createRoute</span>(record, location, redirectedFrom)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (location.<span class="property">path</span>) &#123;</span><br><span class="line">        location.<span class="property">params</span> = &#123;&#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; pathList.<span class="property">length</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">const</span> path = pathList[i]</span><br><span class="line">            <span class="keyword">const</span> record = pathMap[path]</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_">matchRoute</span>(record.<span class="property">regex</span>, location.<span class="property">path</span>, location.<span class="property">params</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="title function_">_createRoute</span>(record, location, redirectedFrom)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// no match</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">_createRoute</span>(<span class="literal">null</span>, location)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">_createRoute</span> (</span><br><span class="line">    <span class="attr">record</span>: ?<span class="title class_">RouteRecord</span>,</span><br><span class="line">    <span class="attr">location</span>: <span class="title class_">Location</span>,</span><br><span class="line">    redirectedFrom?: <span class="title class_">Location</span></span><br><span class="line">): <span class="title class_">Route</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (record &amp;&amp; record.<span class="property">redirect</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">redirect</span>(record, redirectedFrom || location)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (record &amp;&amp; record.<span class="property">matchAs</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">alias</span>(record, location, record.<span class="property">matchAs</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">createRoute</span>(record, location, redirectedFrom, router)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>match</code> 方法接收3个参数，<code>raw</code> 可以是 url 字符串，也可以是 Location 对象,<code>currentRoute</code> 表示当前路径，<code>redirectedFrom</code> 与重定向相关。<code>_createRoute</code> 返回值是一个 <code>Route</code> 路径。</p>
<p><code>_createRoute</code> 最终会调用 <code>createRoute</code> 方法，createRoute 源代码：<em>src&#x2F;uitl&#x2F;route.js</em>:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">createRoute</span> (</span><br><span class="line">    <span class="attr">record</span>: ?<span class="title class_">RouteRecord</span>,</span><br><span class="line">    <span class="attr">location</span>: <span class="title class_">Location</span>,</span><br><span class="line">    redirectedFrom?: ?<span class="title class_">Location</span>,</span><br><span class="line">    router?: <span class="title class_">VueRouter</span></span><br><span class="line">): <span class="title class_">Route</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> stringifyQuery = router &amp;&amp; router.<span class="property">options</span>.<span class="property">stringifyQuery</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="attr">query</span>: any = location.<span class="property">query</span> || &#123;&#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        query = <span class="title function_">clone</span>(query)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="attr">route</span>: <span class="title class_">Route</span> = &#123;</span><br><span class="line">        <span class="attr">name</span>: location.<span class="property">name</span> || (record &amp;&amp; record.<span class="property">name</span>),</span><br><span class="line">        <span class="attr">meta</span>: (record &amp;&amp; record.<span class="property">meta</span>) || &#123;&#125;,</span><br><span class="line">        <span class="attr">path</span>: location.<span class="property">path</span> || <span class="string">&#x27;/&#x27;</span>,</span><br><span class="line">        <span class="attr">hash</span>: location.<span class="property">hash</span> || <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        query,</span><br><span class="line">        <span class="attr">params</span>: location.<span class="property">params</span> || &#123;&#125;,</span><br><span class="line">        <span class="attr">fullPath</span>: <span class="title function_">getFullPath</span>(location, stringifyQuery),</span><br><span class="line">        <span class="attr">matched</span>: record ? <span class="title function_">formatMatch</span>(record) : []</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (redirectedFrom) &#123;</span><br><span class="line">        route.<span class="property">redirectedFrom</span> = <span class="title function_">getFullPath</span>(redirectedFrom, stringifyQuery)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Object</span>.<span class="title function_">freeze</span>(route)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>createRoute</code> 可以根据 <code>record</code> 和 <code>location</code> 创建出来，最终返回的是一条 <code>Route</code> 路径，在 Vue-Router 中，所有的 <code>Route</code> 最终都会通过 <code>createRoute</code> 函数创建，并且它最后是<strong>不可以被外部修改</strong>的。Route 对象中有一个非常重要属性是 <code>matched</code>，它通过 <code>formatMatch(record)</code> 计算而来。</p>
<blockquote>
<p><code>matched</code> 属性非常有用，它为之后渲染组件提供了依据。</p>
</blockquote>
<h4 id="路径切换（重点）"><a href="#路径切换（重点）" class="headerlink" title="路径切换（重点）"></a>路径切换（重点）</h4><p><code>history.transitionTo</code> 是 <code>Vue-Router</code> 中非常重要的方法，在切换路由线路时执行。</p>
<p>上面分析了 <code>matcher</code> 的相关实现，知道它是如何找到匹配的新线路，那么匹配到新线路后又做了哪些事情，这就涉及到 <code>transitionTo</code> 的实现了。源代码 <em>src&#x2F;history&#x2F;base.js</em>：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">transitionTo (<span class="attr">location</span>: <span class="title class_">RawLocation</span>, onComplete?: <span class="title class_">Function</span>, onAbort?: <span class="title class_">Function</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> route = <span class="variable language_">this</span>.<span class="property">router</span>.<span class="title function_">match</span>(location, <span class="variable language_">this</span>.<span class="property">current</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">confirmTransition</span>(route, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">updateRoute</span>(route)</span><br><span class="line">        onComplete &amp;&amp; <span class="title function_">onComplete</span>(route)</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">ensureURL</span>()</span><br><span class="line"></span><br><span class="line">        <span class="comment">// fire ready cbs once</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">ready</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">ready</span> = <span class="literal">true</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">readyCbs</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">cb</span> =&gt;</span> &#123; <span class="title function_">cb</span>(route) &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (onAbort) &#123;</span><br><span class="line">        <span class="title function_">onAbort</span>(err)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (err &amp;&amp; !<span class="variable language_">this</span>.<span class="property">ready</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">ready</span> = <span class="literal">true</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">readyErrorCbs</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">cb</span> =&gt;</span> &#123; <span class="title function_">cb</span>(err) &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>首先根据目标 <code>location</code> 和当前路径 <code>this.current</code> 执行 <code>this.router.match</code> 方法去匹配到目标的路径 <code>route</code>, <code>transitionTo</code> 实际上也就是在切换 <code>this.current</code>。</li>
<li><strong>拿到新的路径后，接下来会执行 <code>confirmTransition</code> 做真正的切换（关键点）</strong>。</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">confirmTransition (<span class="attr">route</span>: <span class="title class_">Route</span>, <span class="attr">onComplete</span>: <span class="title class_">Function</span>, onAbort?: <span class="title class_">Function</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> current = <span class="variable language_">this</span>.<span class="property">current</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">abort</span> = err =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_">isError</span>(err)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">errorCbs</span>.<span class="property">length</span>) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">errorCbs</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">cb</span> =&gt;</span> &#123; <span class="title function_">cb</span>(err) &#125;)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="title function_">warn</span>(<span class="literal">false</span>, <span class="string">&#x27;uncaught error during route navigation:&#x27;</span>)</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">error</span>(err)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        onAbort &amp;&amp; <span class="title function_">onAbort</span>(err)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">        <span class="title function_">isSameRoute</span>(route, current) &amp;&amp;</span><br><span class="line">        <span class="comment">// in the case the route map has been dynamically appended to</span></span><br><span class="line">        route.<span class="property">matched</span>.<span class="property">length</span> === current.<span class="property">matched</span>.<span class="property">length</span></span><br><span class="line">    ) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">ensureURL</span>()</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">abort</span>()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> &#123;</span><br><span class="line">        updated,</span><br><span class="line">        deactivated,</span><br><span class="line">        activated</span><br><span class="line">    &#125; = <span class="title function_">resolveQueue</span>(<span class="variable language_">this</span>.<span class="property">current</span>.<span class="property">matched</span>, route.<span class="property">matched</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="attr">queue</span>: <span class="title class_">Array</span>&lt;?<span class="title class_">NavigationGuard</span>&gt; = [].<span class="title function_">concat</span>(</span><br><span class="line">        <span class="title function_">extractLeaveGuards</span>(deactivated),</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">router</span>.<span class="property">beforeHooks</span>,</span><br><span class="line">        <span class="title function_">extractUpdateHooks</span>(updated),</span><br><span class="line">        activated.<span class="title function_">map</span>(<span class="function"><span class="params">m</span> =&gt;</span> m.<span class="property">beforeEnter</span>),</span><br><span class="line">        <span class="title function_">resolveAsyncComponents</span>(activated)</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">pending</span> = route</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">iterator</span> = (<span class="params">hook: NavigationGuard, next</span>) =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">pending</span> !== route) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">abort</span>()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="title function_">hook</span>(route, current, <span class="function">(<span class="params">to: any</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (to === <span class="literal">false</span> || <span class="title function_">isError</span>(to)) &#123;</span><br><span class="line">                <span class="comment">// next(false) -&gt; abort navigation, ensure current URL</span></span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">ensureURL</span>(<span class="literal">true</span>)</span><br><span class="line">                <span class="title function_">abort</span>(to)</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">                <span class="keyword">typeof</span> to === <span class="string">&#x27;string&#x27;</span> ||</span><br><span class="line">                (<span class="keyword">typeof</span> to === <span class="string">&#x27;object&#x27;</span> &amp;&amp; (</span><br><span class="line">                <span class="keyword">typeof</span> to.<span class="property">path</span> === <span class="string">&#x27;string&#x27;</span> ||</span><br><span class="line">                <span class="keyword">typeof</span> to.<span class="property">name</span> === <span class="string">&#x27;string&#x27;</span></span><br><span class="line">                ))</span><br><span class="line">            ) &#123;</span><br><span class="line">                <span class="comment">// next(&#x27;/&#x27;) or next(&#123; path: &#x27;/&#x27; &#125;) -&gt; redirect</span></span><br><span class="line">                <span class="title function_">abort</span>()</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">typeof</span> to === <span class="string">&#x27;object&#x27;</span> &amp;&amp; to.<span class="property">replace</span>) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">replace</span>(to)</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">push</span>(to)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// confirm transition and pass on the value</span></span><br><span class="line">                <span class="title function_">next</span>(to)</span><br><span class="line">            &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            <span class="title function_">abort</span>(e)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">runQueue</span>(queue, iterator, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> postEnterCbs = []</span><br><span class="line">        <span class="keyword">const</span> <span class="title function_">isValid</span> = (<span class="params"></span>) =&gt; <span class="variable language_">this</span>.<span class="property">current</span> === route</span><br><span class="line">        <span class="comment">// wait until async components are resolved before</span></span><br><span class="line">        <span class="comment">// extracting in-component enter guards</span></span><br><span class="line">        <span class="keyword">const</span> enterGuards = <span class="title function_">extractEnterGuards</span>(activated, postEnterCbs, isValid)</span><br><span class="line">        <span class="keyword">const</span> queue = enterGuards.<span class="title function_">concat</span>(<span class="variable language_">this</span>.<span class="property">router</span>.<span class="property">resolveHooks</span>)</span><br><span class="line">        <span class="title function_">runQueue</span>(queue, iterator, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">pending</span> !== route) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="title function_">abort</span>()</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">pending</span> = <span class="literal">null</span></span><br><span class="line">            <span class="title function_">onComplete</span>(route)</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">router</span>.<span class="property">app</span>) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">router</span>.<span class="property">app</span>.$nextTick(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                    postEnterCbs.<span class="title function_">forEach</span>(<span class="function"><span class="params">cb</span> =&gt;</span> &#123; <span class="title function_">cb</span>() &#125;)</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>首先定义了 <code>abort</code> 函数，判断要跳转的 <code>route</code> 和当前 <code>current</code> 是相同路径的话，直接调用 <code>this.ensureURL</code> 和 <code>abort</code>。</li>
<li>接着根据 <code>current.matched</code> 和 <code>route.matched</code> 执行了 <code>resolveQueue</code> 方法解析出 3 个队列（这里是开始管理更新路由栈），拿到 <code>updated</code>(已更新)、<code>activated</code>（激活）、<code>deactivated</code>（失活） 3 个 <code>ReouteRecord</code> 数组后，接下来就是路径变换后的一个重要部分，执行一系列的钩子函数（<a href="https://router.vuejs.org/zh/guide/advanced/navigation-guards.html#%E5%85%A8%E5%B1%80%E5%89%8D%E7%BD%AE%E5%AE%88%E5%8D%AB">导航守卫</a>）。</li>
</ul>
<h5 id="导航守卫"><a href="#导航守卫" class="headerlink" title="导航守卫"></a>导航守卫</h5><p>路由切换的时候，会执行一系列的钩子函数，我们称之为导航守卫。</p>
<p><img src="/images/js-vue-router/vue-router-guard.png" alt="完整的导航解析流程"></p>
<p>接着继续看上面 <code>confirmTransition</code> 函数中是怎样执行这些钩子函数的，首先构造出一个队列 <code>queue</code>，实际是一个导航守卫数组；然后再定义一个迭代器函数 <code>iterator</code>；最后再执行 <code>runQueue</code> 方法来执行这个队列。</p>
<p><code>runQueue</code> 方法源代码：<em>src&#x2F;util&#x2F;async.js</em></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">runQueue</span> (<span class="attr">queue</span>: <span class="title class_">Array</span>&lt;?<span class="title class_">NavigationGuard</span>&gt;, <span class="attr">fn</span>: <span class="title class_">Function</span>, <span class="attr">cb</span>: <span class="title class_">Function</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">step</span> = index =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (index &gt;= queue.<span class="property">length</span>) &#123;</span><br><span class="line">            <span class="title function_">cb</span>()</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (queue[index]) &#123;</span><br><span class="line">                <span class="title function_">fn</span>(queue[index], <span class="function">() =&gt;</span> &#123;</span><br><span class="line">                <span class="title function_">step</span>(index + <span class="number">1</span>)</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="title function_">step</span>(index + <span class="number">1</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">step</span>(<span class="number">0</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>runQueue</code> 是一个非常经典的异步函数队列执行的模式（小程序请求数限制的优化方案）。<code>queue</code> 是一个 <code>NavigationGuard</code> 类型的数组，这里的 <code>fn</code> 是刚才的 <code>iterator</code> 函数。回到之前 <code>iterator</code> 函数的定义：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">iterator</span> = (<span class="params">hook: NavigationGuard, next</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">pending</span> !== route) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">abort</span>()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="title function_">hook</span>(route, current, <span class="function">(<span class="params">to: any</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (to === <span class="literal">false</span> || <span class="title function_">isError</span>(to)) &#123;</span><br><span class="line">                <span class="comment">// next(false) -&gt; abort navigation, ensure current URL</span></span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">ensureURL</span>(<span class="literal">true</span>)</span><br><span class="line">                <span class="title function_">abort</span>(to)</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">                <span class="keyword">typeof</span> to === <span class="string">&#x27;string&#x27;</span> ||</span><br><span class="line">                (<span class="keyword">typeof</span> to === <span class="string">&#x27;object&#x27;</span> &amp;&amp; (</span><br><span class="line">                <span class="keyword">typeof</span> to.<span class="property">path</span> === <span class="string">&#x27;string&#x27;</span> ||</span><br><span class="line">                <span class="keyword">typeof</span> to.<span class="property">name</span> === <span class="string">&#x27;string&#x27;</span></span><br><span class="line">                ))</span><br><span class="line">            ) &#123;</span><br><span class="line">                <span class="comment">// next(&#x27;/&#x27;) or next(&#123; path: &#x27;/&#x27; &#125;) -&gt; redirect</span></span><br><span class="line">                <span class="title function_">abort</span>()</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">typeof</span> to === <span class="string">&#x27;object&#x27;</span> &amp;&amp; to.<span class="property">replace</span>) &#123;</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="title function_">replace</span>(to)</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="title function_">push</span>(to)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// confirm transition and pass on the value</span></span><br><span class="line">                <span class="title function_">next</span>(to)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="title function_">abort</span>(e)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>iterator</code> 函数的逻辑就是去执行每一个导航守卫 <code>hook</code>，并传入了 <code>route</code>、<code>current</code> 和匿名函数，这三个参数对应 vue-router 官方文档中的 <code>to</code>、<code>from</code>、<code>next</code>。只有执行 next 的时候，才会前进到下一个导航守卫钩子函数中。</p>
<p>最后我们可以看看被遍历执行的 <code>queue</code> 是怎么构造的：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="attr">queue</span>: <span class="title class_">Array</span>&lt;?<span class="title class_">NavigationGuard</span>&gt; = [].<span class="title function_">concat</span>(</span><br><span class="line">    <span class="title function_">extractLeaveGuards</span>(deactivated),</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">router</span>.<span class="property">beforeHooks</span>,</span><br><span class="line">    <span class="title function_">extractUpdateHooks</span>(updated),</span><br><span class="line">    activated.<span class="title function_">map</span>(<span class="function"><span class="params">m</span> =&gt;</span> m.<span class="property">beforeEnter</span>),</span><br><span class="line">    <span class="title function_">resolveAsyncComponents</span>(activated)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>按照顺序如下：</p>
<ol>
<li>在失活的组件里调用离开守卫。</li>
<li>调用全局的 beforeEach 守卫。</li>
<li>在重用的组件里调用 beforeRouteUpdate 守卫。</li>
<li>在激活的路由配置里调用 beforeEnter。</li>
<li>解析异步路由组件。</li>
</ol>
<p>这里执行了<a href="https://router.vuejs.org/zh/guide/advanced/navigation-guards.html#%E7%BB%84%E4%BB%B6%E5%86%85%E7%9A%84%E5%AE%88%E5%8D%AB">完整的导航解析流程</a>的上半部分。</p>
<ul>
<li>第一步是通过执行 <code>extractLeavaGuards(deactivated)</code>, 在失活的组件里调用离开守卫 <code>beforeRouteLeave</code>:</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">extractLeaveGuards</span> (<span class="attr">deactivated</span>: <span class="title class_">Array</span>&lt;<span class="title class_">RouteRecord</span>&gt;): <span class="title class_">Array</span>&lt;?<span class="title class_">Function</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">extractGuards</span>(deactivated, <span class="string">&#x27;beforeRouteLeave&#x27;</span>, bindGuard, <span class="literal">true</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>内部调用了 <code>extractGuards</code> 的通用方法，可以从 <code>RouteRecord</code> 数组中提取各个阶段的守卫：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">extractGuards</span> (</span><br><span class="line">    <span class="attr">records</span>: <span class="title class_">Array</span>&lt;<span class="title class_">RouteRecord</span>&gt;,</span><br><span class="line">    <span class="attr">name</span>: string,</span><br><span class="line">    <span class="attr">bind</span>: <span class="title class_">Function</span>,</span><br><span class="line">    reverse?: boolean</span><br><span class="line">): <span class="title class_">Array</span>&lt;?<span class="title class_">Function</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> guards = <span class="title function_">flatMapComponents</span>(records, <span class="function">(<span class="params">def, instance, match, key</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// def 是 route</span></span><br><span class="line">        <span class="keyword">const</span> guard = <span class="title function_">extractGuard</span>(def, name)</span><br><span class="line">        <span class="keyword">if</span> (guard) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="title class_">Array</span>.<span class="title function_">isArray</span>(guard)</span><br><span class="line">                ? guard.<span class="title function_">map</span>(<span class="function"><span class="params">guard</span> =&gt;</span> <span class="title function_">bind</span>(guard, instance, match, key))</span><br><span class="line">                : <span class="title function_">bind</span>(guard, instance, match, key)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">flatten</span>(reverse ? guards.<span class="title function_">reverse</span>() : guards)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">flatMapComponents</span> (</span><br><span class="line">    <span class="attr">matched</span>: <span class="title class_">Array</span>&lt;<span class="title class_">RouteRecord</span>&gt;,</span><br><span class="line">    <span class="attr">fn</span>: <span class="title class_">Function</span></span><br><span class="line">): <span class="title class_">Array</span>&lt;?<span class="title class_">Function</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">flatten</span>(matched.<span class="title function_">map</span>(<span class="function"><span class="params">m</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Object</span>.<span class="title function_">keys</span>(m.<span class="property">components</span>).<span class="title function_">map</span>(<span class="function"><span class="params">key</span> =&gt;</span> <span class="title function_">fn</span>(</span><br><span class="line">            m.<span class="property">components</span>[key],</span><br><span class="line">            m.<span class="property">instances</span>[key],</span><br><span class="line">            m, key</span><br><span class="line">        ))</span><br><span class="line">    &#125;))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// flatten 作用是把二维数组扁平为一维数组</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">flatten</span> (<span class="attr">arr</span>: <span class="title class_">Array</span>&lt;any&gt;): <span class="title class_">Array</span>&lt;any&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Array</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">concat</span>.<span class="title function_">apply</span>([], arr)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong><code>flatMapComponents</code> 的作用就是返回一个数组</strong>。数组的元素是从 <code>matched</code> 里获取到所有组件的 <code>key</code>，然后返回 <code>fn</code> 函数执行的结果，<code>flatten</code> 作用是把二维数组扁平为一维数组。</p>
<p>那么对于 <code>extractGuards</code> 中 <code>flatMapComponents</code> 的调用，执行每个 <code>fn</code> 的时候，<strong>通过 <code>extractGuard(def, name)</code> 获取到组件中对应 <code>name</code> 的导航守卫 <code>def.options[key]</code></strong></p>
<p>获取到 <code>guard</code> 后，还会调用 <code>bind</code> 方法把组件的实例 <code>instance</code> 作为函数执行的上下文绑定到 <code>guard</code> 上，<code>bind</code> 方法的对应的是 <code>bindGuard</code>:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">bindGuard</span> (<span class="attr">guard</span>: <span class="title class_">NavigationGuard</span>, <span class="attr">instance</span>: ?_Vue): ?<span class="title class_">NavigationGuard</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (instance) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">boundRouteGuard</span> () &#123;</span><br><span class="line">            <span class="keyword">return</span> guard.<span class="title function_">apply</span>(instance, <span class="variable language_">arguments</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>总结：<strong>那么对于 <code>extractLeaveGuards(deactivated)</code> 而言，获取到的就是所有失活组件中定义的 <code>beforeRouteLeave</code> 钩子函数。</strong></p>
<ul>
<li><p>第二步是 <code>this.router.beforeHooks</code>, 获取的就是用户注册的全局 <code>beforeEach</code> 守卫。</p>
</li>
<li><p>第三步执行了 <code>extractUpdateHooks(updated)</code>，和 <code>extractLeaveGuards(deactivated)</code> 类似，<code>extractUpdateHooks(updated)</code> 获取到的就是所有重用的组件中定义的 <code>beforeRouteUpdate</code> 钩子函数。</p>
</li>
<li><p>第四步执行了 <code>activated.map(m =&gt; m.beforeEnter)</code>，获取的是在激活的路由配置中定义的 <code>beforeEnter</code> 函数。</p>
</li>
<li><p>第五步是执行 <code>resolveAsyncComponents(activated)</code> 解析<strong>异步组件</strong>，解析完所有激活的异步组件后，我们就可以拿到这一次所有激活的组件。</p>
</li>
</ul>
<p>终于可以来到了重点的执行环节了：<code>runQueue</code>！</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">runQueue</span>(queue, iterator, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> postEnterCbs = []</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">isValid</span> = (<span class="params"></span>) =&gt; <span class="variable language_">this</span>.<span class="property">current</span> === route</span><br><span class="line">    <span class="comment">// wait until async components are resolved before</span></span><br><span class="line">    <span class="comment">// extracting in-component enter guards</span></span><br><span class="line">    <span class="keyword">const</span> enterGuards = <span class="title function_">extractEnterGuards</span>(activated, postEnterCbs, isValid)</span><br><span class="line">    <span class="keyword">const</span> queue = enterGuards.<span class="title function_">concat</span>(<span class="variable language_">this</span>.<span class="property">router</span>.<span class="property">resolveHooks</span>)</span><br><span class="line">    <span class="title function_">runQueue</span>(queue, iterator, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">pending</span> !== route) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">abort</span>()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">pending</span> = <span class="literal">null</span></span><br><span class="line">        <span class="title function_">onComplete</span>(route)</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">router</span>.<span class="property">app</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">router</span>.<span class="property">app</span>.$nextTick(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                postEnterCbs.<span class="title function_">forEach</span>(<span class="function"><span class="params">cb</span> =&gt;</span> &#123; <span class="title function_">cb</span>() &#125;)</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>在被激活的组件里调用 <code>beforeRouteEnter</code>。</li>
<li>调用全局的 <code>beforeResolve</code> 守卫 (2.5+)。</li>
<li>导航被确认。</li>
<li>调用全局的 afterEach 钩子。</li>
</ol>
<p>关于钩子函数的逻辑，后面有空再详细分析。路由在切换时除了执行钩子函数，还有关键的 2 个地方会发生变化：<strong>一个是 url 发生变化，一个是组件发生变化</strong>。</p>
<h5 id="URL"><a href="#URL" class="headerlink" title="URL"></a>URL</h5><p>必须得搞懂！</p>
<p>不管是点击 <code>router-link</code> 还是直接调用直接调用 <code>this.$router.push</code>，都是调用 <code>history.push</code>：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">push (<span class="attr">location</span>: <span class="title class_">RawLocation</span>, onComplete?: <span class="title class_">Function</span>, onAbort?: <span class="title class_">Function</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">history</span>.<span class="title function_">push</span>(location, onComplete, onAbort)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们看看 <code>hash</code> 模式下 <code>push</code> 函数的实现，源代码：<em>src&#x2F;history&#x2F;hash.js</em></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">push (<span class="attr">location</span>: <span class="title class_">RawLocation</span>, onComplete?: <span class="title class_">Function</span>, onAbort?: <span class="title class_">Function</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; <span class="attr">current</span>: fromRoute &#125; = <span class="variable language_">this</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">transitionTo</span>(location, <span class="function"><span class="params">route</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">pushHash</span>(route.<span class="property">fullPath</span>)</span><br><span class="line">        <span class="title function_">handleScroll</span>(<span class="variable language_">this</span>.<span class="property">router</span>, route, fromRoute, <span class="literal">false</span>)</span><br><span class="line">        onComplete &amp;&amp; <span class="title function_">onComplete</span>(route)</span><br><span class="line">    &#125;, onAbort)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>push 函数会先执行 this.transitionTo 切换路径（具体流程参考上面分析），在切换完成后执行回调函数，pushHash 函数：</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">pushHash</span> (path) &#123;</span><br><span class="line">    <span class="keyword">if</span> (supportsPushState) &#123;</span><br><span class="line">        <span class="title function_">pushState</span>(<span class="title function_">getUrl</span>(path))</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">hash</span> = path</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">pushState</span> (url?: string, replace?: boolean) &#123;</span><br><span class="line">  <span class="title function_">saveScrollPosition</span>() <span class="comment">// 保存当前组件的滑动位置</span></span><br><span class="line">  <span class="keyword">const</span> history = <span class="variable language_">window</span>.<span class="property">history</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (replace) &#123;</span><br><span class="line">      history.<span class="title function_">replaceState</span>(&#123; <span class="attr">key</span>: _key &#125;, <span class="string">&#x27;&#x27;</span>, url)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      _key = <span class="title function_">genKey</span>()</span><br><span class="line">      history.<span class="title function_">pushState</span>(&#123; <span class="attr">key</span>: _key &#125;, <span class="string">&#x27;&#x27;</span>, url)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="variable language_">window</span>.<span class="property">location</span>[replace ? <span class="string">&#x27;replace&#x27;</span> : <span class="string">&#x27;assign&#x27;</span>](url)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>pushState</code> 会调用浏览器原生的 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/History_API"><code>window.history</code></a> 的 <code>pushState</code> 接口或者 <code>replaceState</code> 接口，添加和修改历史记录条目，更新浏览器的 <code>url</code> 地址，并把当前 <code>url</code> 压入历史栈中。</p>
<p>关于 <code>pushState</code> 的详细讲解，请参考 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/History_API"><code>MDN</code></a>。</p>
<p><strong>注意，调用 pushState 后浏览器并不会立即加载这个URL，但可能会在稍后某些情况下加载这个URL，比如在用户重新打开浏览器时。</strong></p>
<p>而且在 VueRouter 初始化 history 时，会调用 <code>history.setupListeners()</code> 设置一个监听器，监听历史栈的变化：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">setupListeners () &#123;</span><br><span class="line">    <span class="keyword">const</span> router = <span class="variable language_">this</span>.<span class="property">router</span></span><br><span class="line">    <span class="keyword">const</span> expectScroll = router.<span class="property">options</span>.<span class="property">scrollBehavior</span></span><br><span class="line">    <span class="keyword">const</span> supportsScroll = supportsPushState &amp;&amp; expectScroll</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (supportsScroll) &#123;</span><br><span class="line">        <span class="title function_">setupScroll</span>()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(supportsPushState ? <span class="string">&#x27;popstate&#x27;</span> : <span class="string">&#x27;hashchange&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> current = <span class="variable language_">this</span>.<span class="property">current</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_">ensureSlash</span>()) &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">transitionTo</span>(<span class="title function_">getHash</span>(), <span class="function"><span class="params">route</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (supportsScroll) &#123;</span><br><span class="line">                <span class="title function_">handleScroll</span>(<span class="variable language_">this</span>.<span class="property">router</span>, route, current, <span class="literal">true</span>)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!supportsPushState) &#123;</span><br><span class="line">                <span class="title function_">replaceHash</span>(route.<span class="property">fullPath</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当点击浏览器返回按钮的时候，则会触发 <code>popstate</code> 事件，然后拿到当前要跳转的 <code>hash</code>，执行 <code>transtionTo</code> 方法做一次路径转换。</p>
<p>总结：<code>pushState</code> 和 <code>onpopstate</code> 就是 <code>hash</code> 模式下 <code>url</code> 变化过程的核心了。</p>
<h5 id="组件"><a href="#组件" class="headerlink" title="组件"></a>组件</h5><p>当我们知道路由 url 的切换过程后，接下来就需要了解 <code>&lt;router-view&gt;</code> 组件是如何自动渲染最新路由的。源代码：<em>srx&#x2F;components&#x2F;view.js</em>：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">render (_, &#123; props, children, parent, data &#125;) &#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">h</span>(component, data, children)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>组件 <code>render</code> 渲染函数首先获取当前的路径：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> route = parent.<span class="property">$route</span></span><br></pre></td></tr></table></figure>

<p><code>&lt;router-view&gt;</code> 是支持嵌套的，需要遍历父节点，找出当前 <code>router-view</code> 的深度 <code>depth</code>，再根据当前线路匹配的路径和 <code>depth</code> 找到对应的 <code>RouteRecord</code>，进而找到该渲染的组件。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> depth = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> (parent &amp;&amp; parent.<span class="property">_routerRoot</span> !== parent) &#123;</span><br><span class="line">    <span class="keyword">if</span> (parent.<span class="property">$vnode</span> &amp;&amp; parent.<span class="property">$vnode</span>.<span class="property">data</span>.<span class="property">routerView</span>) &#123;</span><br><span class="line">        depth++</span><br><span class="line">    &#125;</span><br><span class="line">    parent = parent.<span class="property">$parent</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> matched = route.<span class="property">matched</span>[depth]</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> component = cache[name] = matched.<span class="property">components</span>[name]</span><br></pre></td></tr></table></figure>

<p>除了找到了应该渲染的组件 <code>component</code>，还定义了一个注册路由实例的方法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">data.<span class="property">registerRouteInstance</span> = <span class="function">(<span class="params">vm, val</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> current = matched.<span class="property">instances</span>[name]</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">        (val &amp;&amp; current !== vm) ||</span><br><span class="line">        (!val &amp;&amp; current === vm)</span><br><span class="line">    ) &#123;</span><br><span class="line">        matched.<span class="property">instances</span>[name] = val</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>给 <code>vnode</code> 的 <code>data</code> 定义了 <code>registerRouteInstance</code> 方法，其实在文章一开始的 <code>install</code> 时 <code>beforeCreate</code> 钩子函数 <code>mixin</code> 调用的 <code>registerInstance</code>，本质上就是调用上述的 <code>data.registerRouteInstance</code> 函数：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">registerInstance</span> = (<span class="params">vm, callVal</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> i = vm.<span class="property">$options</span>.<span class="property">_parentVnode</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isDef</span>(i) &amp;&amp; <span class="title function_">isDef</span>(i = i.<span class="property">data</span>) &amp;&amp; <span class="title function_">isDef</span>(i = i.<span class="property">registerRouteInstance</span>)) &#123;</span><br><span class="line">    <span class="title function_">i</span>(vm, callVal)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Vue</span>.<span class="title function_">mixin</span>(&#123;</span><br><span class="line">  beforeCreate () &#123;</span><br><span class="line">    <span class="comment">// 相当于调用了 data.registerRouteInstance</span></span><br><span class="line">    <span class="title function_">registerInstance</span>(<span class="variable language_">this</span>, <span class="variable language_">this</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">  destroyed () &#123;</span><br><span class="line">    <span class="title function_">registerInstance</span>(<span class="variable language_">this</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><code>registerInstance</code> 的目的是给 <code>matched.instances[name]</code> 赋值当前组件的 <code>vm</code> 实例。</p>
<p><code>render</code> 函数的最后根据 <code>component</code> 渲染出对应的组件 <code>vonde</code>：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="title function_">h</span>(component, data, children)</span><br></pre></td></tr></table></figure>

<p><strong>关键点</strong>：那么当我们执行 <code>transitionTo</code> 来更改路由线路后，组件是如何重新渲染的呢？</p>
<p>答案是 <code>beforeCreate</code> 钩子函数的 <code>Vue.util.defineReactive(this, &#39;_route&#39;, this._router.history.current)</code> 中的 <code>_route</code>。</p>
<p>由于根Vue实例的 <code>_route</code> 属性是响应式的，当 <code>render</code> 函数访问 <code>parent.$route</code> 时，两者就产生了依赖。所以每当执行完 <code>transitionTo</code> 后，修改 <code>app._route</code> 时，就会通知渲染 <code>watcher</code> 更新，重新渲染组件。</p>
<p>one more time analyse（再回顾收集依赖和触发依赖的过程）：</p>
<p><code>&lt;router-view&gt;</code> 异步组件中的 <code>render</code> 渲染函数：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> route = parent.<span class="property">$route</span></span><br></pre></td></tr></table></figure>

<p>而这个 <code>parent</code> 实例的 <code>$route</code> 是在 <code>src/install.js</code> 中定义的：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(<span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>, <span class="string">`$route`</span>, &#123;</span><br><span class="line">    get () &#123; <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">_routerRoot</span>.<span class="property">_route</span> &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>① <code>render</code> 函数读取 <code>parent.$route</code> 时就会触发 <code>render</code> 的 <code>getter</code>，收集其依赖。</p>
<p>然后再 <code>new Vue(&#123;router&#125;)</code> 时执行 <code>this._router.init</code>：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">history.<span class="title function_">listen</span>(<span class="function"><span class="params">route</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">apps</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">app</span>) =&gt;</span> &#123;</span><br><span class="line">        app.<span class="property">_route</span> = route</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">listen (<span class="attr">cb</span>: <span class="title class_">Function</span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">cb</span> = cb</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>history.listen</code> 接收的函数参数，是被设置为完成更新路由后的回调函数 <code>cb</code>：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">history.<span class="title function_">listen</span>(<span class="function"><span class="params">route</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">apps</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">app</span>) =&gt;</span> &#123;</span><br><span class="line">        app.<span class="property">_route</span> = route</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">listen (<span class="attr">cb</span>: <span class="title class_">Function</span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">cb</span> = cb</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>会在更新路由函数 <code>updateRoute</code> 执行 <code>this.cb</code>：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">updateRoute (<span class="attr">route</span>: <span class="title class_">Route</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> prev = <span class="variable language_">this</span>.<span class="property">current</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">current</span> = route</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">cb</span> &amp;&amp; <span class="variable language_">this</span>.<span class="title function_">cb</span>(route)  <span class="comment">// 被执行的回调函数</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>也就是执行 <code>transitionTo</code> 方法最后执行的 <code>updateRoute</code> 的时候执行回调 <code>cb</code>, 会将 <code>this.apps</code> 保存的组件实例 <code>app</code> 的 <code>_route</code> 设置为当前 <code>route</code>（<code>this.apps</code> 数组保存的实例的特点都是在初始化的时候有传入了 <code>router</code> 配置项的，一般的场景数组只会保存根 <code>Vue</code> 实例，数组长度为 1，因为我们只有在 <code>new Vue</code> 时传入了 <code>router</code> 实例。</p>
<p>② 由于修改 <code>app._route</code> 的时候，又触发了 <code>setter</code>，因此会通知 <code>&lt;router-view&gt;</code> 的渲染 watcher 更新，重新渲染组件。</p>
<p>本文主要参考了 <a href="https://ustbhuangyi.github.io/vue-analysis/v2/vue-router/router.html#%E6%80%BB%E7%BB%93">Vue.js 技术揭秘</a>，再加上自己的一点理解和注释。</p>
<p>参考文章：
<a href="https://ustbhuangyi.github.io/vue-analysis/v2/vue-router/router.html#%E6%80%BB%E7%BB%93">Vue.js 技术揭秘</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://zeuscoder.github.io/2020/03/19/js-vue-router/" data-id="clvynbzq1002dazc922bdal83" class="article-share-link">
        分享
      </a>
      
    </footer>

  </div>

  
  
<nav class="article-nav">
  
  <a href="/2020/03/22/js-this/" class="article-nav-link">
    <strong class="article-nav-caption">前一篇</strong>
    <div class="article-nav-title">
      
      JS：this 备忘录
      
    </div>
  </a>
  
  
  <a href="/2020/03/19/js-vuex/" class="article-nav-link">
    <strong class="article-nav-caption">后一篇</strong>
    <div class="article-nav-title">JS：浅析 Vuex</div>
  </a>
  
</nav>

  

  
  
  
  

</article>
</section>
    <footer class="footer">
  <div class="outer">
    <div class="float-right">
      <ul class="list-inline">
  
  <li><i class="fe fe-smile-alt"></i> <span id="busuanzi_value_site_uv"></span></li>
  
  <li><i class="fe fe-bookmark"></i> <span id="busuanzi_value_page_pv"></span></li>
  
</ul>
    </div>
    <ul class="list-inline">
      <li>zeus の blog &copy; 2024</li>
      
        <li></li>
      
      <li>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a></li>
      <li>theme  <a href="https://github.com/zhwangart/hexo-theme-ocean">Ocean</a></li>
    </ul>
  </div>
</footer>
  </main>
  <aside class="sidebar">
    <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/zeus.png" alt="zeus の blog"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/gallery">相册</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/about">关于</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link nav-item-search" title="搜索">
        <i class="fe fe-search"></i>
        搜索
      </a>
    </li>
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      <div class="totop" id="totop">
  <i class="fe fe-rocket"></i>
</div>
    </li>
    <li class="nav-item">
      
      <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
        <i class="fe fe-feed"></i>
      </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
  </aside>
  
<script src="/js/jquery-2.0.3.min.js"></script>


<script src="/js/jquery.justifiedGallery.min.js"></script>


<script src="/js/lazyload.min.js"></script>


<script src="/js/busuanzi-2.3.pure.min.js"></script>



<script src="/js/wrapImage.js"></script>


<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/copybtn.js"></script>





<script src="/js/tocbot.min.js"></script>

<script>
  // Tocbot_v4.7.0  http://tscanlin.github.io/tocbot/
  tocbot.init({
    tocSelector: '.tocbot',
    contentSelector: '.article-entry',
    headingSelector: 'h1, h2, h3, h4, h5, h6',
    hasInnerContainers: true,
    scrollSmooth: true,
    positionFixedSelector: '.tocbot',
    positionFixedClass: 'is-position-fixed',
    fixedSidebarOffset: 'auto',
  });
</script>



<script src="/js/ocean.js"></script>

</body>

</html>